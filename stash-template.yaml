# Stash 专用配置模板
# 根据 Stash Wiki 官方最佳实践 (https://stash.wiki/faq/effective-stash) 进行了优化。

mixed-port: 7890
ipv6: true
allow-lan: true
unified-delay: true
tcp-concurrent: true
external-controller: 127.0.0.1:9090
# external-ui: Stash 本身就是 UI，无需此项

# GeoIP/GeoSite 相关配置
geodata-mode: true
geo-auto-update: true
geo-update-interval: 24 # 更新间隔，单位为小时
geox-url:
  geoip: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/geoip.dat"
  mmdb: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-Country.mmdb"
  geosite: "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat"
  asn: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-ASN.mmdb"

# 进程匹配模式 (仅适用于 macOS/Linux)
find-process-mode: strict

# 全局 TLS 指纹，用于模仿特定客户端的 TLS 握手包
global-client-fingerprint: firefox

profile:
  store-selected: true # 记录手动选择的代理
  store-fake-ip: true # 记录 fake-ip 的映射关系

sniffer:
  enable: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
  skip-domain:
    - "Mijia Cloud"
    - "+.push.apple.com"

tun:
  enable: false
  stack: gvisor
  dns-hijack:
    - "any:53"
    - "tcp://any:53"
  auto-route: true
  auto-redirect: true
  auto-detect-interface: true

# DNS 配置
dns:
#正确分流：https://www.aloxaf.com/2025/04/how_to_use_geosite/

  # geosite 规则大致介绍
    # category-ads: 包含了常见的广告域名。
    # category-ads-all: 包含了常见的广告域名，以及广告提供商的域名。
    # cn: 相当于 geolocation-cn 和 tld-cn 的合集。
    # google: 包含了 Google 旗下的所有域名。
    # facebook: 包含了 Facebook 旗下的所有域名。
    # geolocation-cn: 包含了常见的国内站点的域名。
    # geolocation-!cn: 包含了常见的非国内站点的域名。
    # speedtest: 包含了所有 Speedtest 所用的域名。
    # tld-cn: 包含了所有 .cn 和 .中国 结尾的域名。


  #mihomo发送给代理节点的是域名而不是ip地址，本地解析结果仅用于分流判断
  #GEOIP 规则用于根据数据包的目标 IP 地址的国家代码路由数据包，注意，是目标IP！
  #也就是dns这一坨配置，大部分是用于分流的，所以要避免本地dns的污染结果，造成根据ip进行分流的错误，本地dns解析一次，分流后，匹配走代理的请求，经过代理再进行一次dns请求
  enable: true
  ipv6: true
  use-system-hosts: false

  default-nameserver: #默认 DNS, 用于解析 DNS 服务器 的域名 必须为 IP
  - https://[2001:4860:4860::64]/dns-query
  - 94.140.14.141
  - 2a10:50c0::1:ff
  - 2a10:50c0::2:ff
  - 149.112.112.9
  - 149.112.112.112
  - 2620:fe::fe
  - 2620:fe::9

  proxy-server-nameserver: #代理节点域名解析服务器，仅用于解析代理节点的域名（需要确保dns无污染，否则没法连接代理服务器啊）,如果不填则遵循 nameserver-policy、nameserver 和 fallback 的配置
  - https://1.12.12.12/dns-query
  - https://223.5.5.5/dns-query

  direct-nameserver-follow-policy: false #是否遵循 nameserver-policy，默认为不遵守，仅当 direct-nameserver 不为空时生效
  direct-nameserver: #用于 direct 直连出口域名解析的 DNS 服务器，如果不填则遵循 nameserver-policy、nameserver 和 fallback 的配置
  - https://1.12.12.12/dns-query
  - https://223.5.5.5/dns-query

  nameserver-policy: #指定域名查询的解析服务器，可使用 geosite, 优先于 nameserver/fallback 查询键支持域名通配值支持字符串/数组
    "geosite:cn,private": #指定国内私有域名等使用国内的dns解析
    - https://1.12.12.12/dns-query
    - https://223.5.5.5/dns-query
    "geosite:gfw,geolocation-!cn": #非国内域名，被污染域名，走另一个解析
    - https://[2001:4860:4860::64]/dns-query
    - tls://1dot1dot1dot1.cloudflare-dns.com
    - tls://unfiltered.adguard-dns.com

  #nameserver和fallback是并发,优先使用哪个看下面的配置规则，比如fallback-filter,上面的设置优先级高，匹配不到了才会走到nameserver fallback判断
  #这里不用fallback了，上面的判断已经够全了，nameserver用来兜底
  nameserver: #默认的域名解析服务器
  - https://[2001:4860:4860::64]/dns-query
  - tls://1dot1dot1dot1.cloudflare-dns.com
  - tls://unfiltered.adguard-dns.com

#fake-ip 模式下，Clash 会将原始的域名（hostname）发送到预先配置的远端DNS 服务器进行解析
  enhanced-mode: fake-ip
  fake-ip-filter-mode: blacklist #blacklist 模式只要没命中fake-ip-filter,都会给fake ip
  fake-ip-filter: #fakeip 过滤，以下地址不会下发 fakeip 映射用于连接
  - +.tvkuai.com
  - geosite:private
  - geosite:cn
  fake-ip-range: 198.18.0.1/16

# 代理组配置
proxy-groups:
  - name: ✈️ 选择代理
    type: select
    proxies:
      - ⚡️ 自动优选
      - ⚖️ 负载均衡
      - 👆 手动选择
      - DIRECT

  - name: ⚡️ 自动优选
    type: url-test # 通过 URL 测试选择延迟最低的节点
    tolerance: 10 # 延迟容忍值（ms），当最优节点延迟与新节点差异小于此值时不切换
    include-all: true # Stash 兼容性写法
    url: "https://www.gstatic.com/generate_204" # 使用 Google 的专用网络连通性测试 URL，更轻量高效
    expected-status: 204 # 期望获得 204 状态码，确保测试的准确性，避免被劫持
    interval: 60 # 健康检查间隔（秒）
    timeout: 3000 # 健康检查超时时间（毫秒）
    max-failed-times: 2 # 最大失败次数
    lazy: true # 懒加载，启动时不进行测试

  - name: ⚖️ 负载均衡
    type: load-balance # 实现流量的负载均衡
    strategy: consistent-hashing # 轮询策略，确保同一目标地址使用同一节点
    include-all: true # Stash 兼容性写法
    url: "https://www.gstatic.com/generate_204"
    expected-status: 204
    interval: 60
    timeout: 3000
    max-failed-times: 2
    lazy: true

  - name: 👆 手动选择
    type: select # 手动选择节点
    include-all: true # Stash 兼容性写法
    url: "https://www.gstatic.com/generate_204"
    expected-status: 204
    interval: 60
    timeout: 3000
    max-failed-times: 2
    lazy: true

# 规则集提供者
rule-providers:
  applications:
    type: http
    # 必须使用 classical 模式，因为其内容是 `PROCESS-NAME` 规则，而非纯域名列表
    behavior: classical
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt"
    path: ./ruleset/applications.yaml
    interval: 86400 # 每天更新一次

# 路由规则
rules:
  # 根据 Stash 官方建议，禁用 QUIC 协议以提高代理转发效率
  - DOMAIN-KEYWORD,quic,REJECT
  # 自定义直连规则
  - DOMAIN,cdn.jsdelivr.net,DIRECT
  - DOMAIN,a.ppconverter.eu.org,DIRECT
  - DOMAIN,clash.razord.top,DIRECT
  - DOMAIN,yacd.haishan.me,DIRECT
  - 'DOMAIN-SUFFIX,ghproxy.com,DIRECT'
  - 'DOMAIN-SUFFIX,gofile.io,DIRECT'
  # 直连应用
  - RULE-SET,applications,DIRECT
  # 广告拦截
  - GEOSITE,category-ads-all,REJECT
  # 常用服务
  - GEOSITE,bing,✈️ 选择代理
  - GEOSITE,microsoft,✈️ 选择代理
  # 私有网络
  - GEOSITE,private,DIRECT
  # 国内流量直连
  - GEOSITE,cn,DIRECT
  # 国外流量走代理
  - GEOSITE,geolocation-!cn,✈️ 选择代理
  # 私有网络
  - GEOIP,private,DIRECT
  # 国内流量直连
  - GEOIP,cn,DIRECT
  # 兜底规则
  - MATCH,✈️ 选择代理
