# Stash ä¸“ç”¨é…ç½®æ¨¡æ¿
# æ ¹æ® Stash Wiki å®˜æ–¹æœ€ä½³å®è·µ (https://stash.wiki/faq/effective-stash) è¿›è¡Œäº†ä¼˜åŒ–ã€‚

mixed-port: 7890
ipv6: true
allow-lan: true
unified-delay: true
tcp-concurrent: true
external-controller: 127.0.0.1:9090
# external-ui: Stash æœ¬èº«å°±æ˜¯ UIï¼Œæ— éœ€æ­¤é¡¹

# GeoIP/GeoSite ç›¸å…³é…ç½®
geodata-mode: true
geo-auto-update: true
geo-update-interval: 24 # æ›´æ–°é—´éš”ï¼Œå•ä½ä¸ºå°æ—¶
geox-url:
  geoip: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/geoip.dat"
  mmdb: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-Country.mmdb"
  geosite: "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat"
  asn: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-ASN.mmdb"

# è¿›ç¨‹åŒ¹é…æ¨¡å¼ (ä»…é€‚ç”¨äº macOS/Linux)
find-process-mode: strict

# å…¨å±€ TLS æŒ‡çº¹ï¼Œç”¨äºæ¨¡ä»¿ç‰¹å®šå®¢æˆ·ç«¯çš„ TLS æ¡æ‰‹åŒ…
global-client-fingerprint: firefox

profile:
  store-selected: true # è®°å½•æ‰‹åŠ¨é€‰æ‹©çš„ä»£ç†
  store-fake-ip: true # è®°å½• fake-ip çš„æ˜ å°„å…³ç³»

sniffer:
  enable: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
  skip-domain:
    - "Mijia Cloud"
    - "+.push.apple.com"

tun:
  enable: false
  stack: gvisor
  dns-hijack:
    - "any:53"
    - "tcp://any:53"
  auto-route: true
  auto-redirect: true
  auto-detect-interface: true

# DNS é…ç½®
dns:
#æ­£ç¡®åˆ†æµï¼šhttps://www.aloxaf.com/2025/04/how_to_use_geosite/

  # geosite è§„åˆ™å¤§è‡´ä»‹ç»
    # category-ads: åŒ…å«äº†å¸¸è§çš„å¹¿å‘ŠåŸŸåã€‚
    # category-ads-all: åŒ…å«äº†å¸¸è§çš„å¹¿å‘ŠåŸŸåï¼Œä»¥åŠå¹¿å‘Šæä¾›å•†çš„åŸŸåã€‚
    # cn: ç›¸å½“äº geolocation-cn å’Œ tld-cn çš„åˆé›†ã€‚
    # google: åŒ…å«äº† Google æ——ä¸‹çš„æ‰€æœ‰åŸŸåã€‚
    # facebook: åŒ…å«äº† Facebook æ——ä¸‹çš„æ‰€æœ‰åŸŸåã€‚
    # geolocation-cn: åŒ…å«äº†å¸¸è§çš„å›½å†…ç«™ç‚¹çš„åŸŸåã€‚
    # geolocation-!cn: åŒ…å«äº†å¸¸è§çš„éå›½å†…ç«™ç‚¹çš„åŸŸåã€‚
    # speedtest: åŒ…å«äº†æ‰€æœ‰ Speedtest æ‰€ç”¨çš„åŸŸåã€‚
    # tld-cn: åŒ…å«äº†æ‰€æœ‰ .cn å’Œ .ä¸­å›½ ç»“å°¾çš„åŸŸåã€‚


  #mihomoå‘é€ç»™ä»£ç†èŠ‚ç‚¹çš„æ˜¯åŸŸåè€Œä¸æ˜¯ipåœ°å€ï¼Œæœ¬åœ°è§£æç»“æœä»…ç”¨äºåˆ†æµåˆ¤æ–­
  #GEOIP è§„åˆ™ç”¨äºæ ¹æ®æ•°æ®åŒ…çš„ç›®æ ‡ IP åœ°å€çš„å›½å®¶ä»£ç è·¯ç”±æ•°æ®åŒ…ï¼Œæ³¨æ„ï¼Œæ˜¯ç›®æ ‡IPï¼
  #ä¹Ÿå°±æ˜¯dnsè¿™ä¸€å¨é…ç½®ï¼Œå¤§éƒ¨åˆ†æ˜¯ç”¨äºåˆ†æµçš„ï¼Œæ‰€ä»¥è¦é¿å…æœ¬åœ°dnsçš„æ±¡æŸ“ç»“æœï¼Œé€ æˆæ ¹æ®ipè¿›è¡Œåˆ†æµçš„é”™è¯¯ï¼Œæœ¬åœ°dnsè§£æä¸€æ¬¡ï¼Œåˆ†æµåï¼ŒåŒ¹é…èµ°ä»£ç†çš„è¯·æ±‚ï¼Œç»è¿‡ä»£ç†å†è¿›è¡Œä¸€æ¬¡dnsè¯·æ±‚
  enable: true
  ipv6: true
  use-system-hosts: false

  default-nameserver: #é»˜è®¤ DNS, ç”¨äºè§£æ DNS æœåŠ¡å™¨ çš„åŸŸå å¿…é¡»ä¸º IP
  - https://[2001:4860:4860::64]/dns-query
  - 94.140.14.141
  - 2a10:50c0::1:ff
  - 2a10:50c0::2:ff
  - 149.112.112.9
  - 149.112.112.112
  - 2620:fe::fe
  - 2620:fe::9

  proxy-server-nameserver: #ä»£ç†èŠ‚ç‚¹åŸŸåè§£ææœåŠ¡å™¨ï¼Œä»…ç”¨äºè§£æä»£ç†èŠ‚ç‚¹çš„åŸŸåï¼ˆéœ€è¦ç¡®ä¿dnsæ— æ±¡æŸ“ï¼Œå¦åˆ™æ²¡æ³•è¿æ¥ä»£ç†æœåŠ¡å™¨å•Šï¼‰,å¦‚æœä¸å¡«åˆ™éµå¾ª nameserver-policyã€nameserver å’Œ fallback çš„é…ç½®
  - https://1.12.12.12/dns-query
  - https://223.5.5.5/dns-query

  direct-nameserver-follow-policy: false #æ˜¯å¦éµå¾ª nameserver-policyï¼Œé»˜è®¤ä¸ºä¸éµå®ˆï¼Œä»…å½“ direct-nameserver ä¸ä¸ºç©ºæ—¶ç”Ÿæ•ˆ
  direct-nameserver: #ç”¨äº direct ç›´è¿å‡ºå£åŸŸåè§£æçš„ DNS æœåŠ¡å™¨ï¼Œå¦‚æœä¸å¡«åˆ™éµå¾ª nameserver-policyã€nameserver å’Œ fallback çš„é…ç½®
  - https://1.12.12.12/dns-query
  - https://223.5.5.5/dns-query

  nameserver-policy: #æŒ‡å®šåŸŸåæŸ¥è¯¢çš„è§£ææœåŠ¡å™¨ï¼Œå¯ä½¿ç”¨ geosite, ä¼˜å…ˆäº nameserver/fallback æŸ¥è¯¢é”®æ”¯æŒåŸŸåé€šé…å€¼æ”¯æŒå­—ç¬¦ä¸²/æ•°ç»„
    "geosite:cn,private": #æŒ‡å®šå›½å†…ç§æœ‰åŸŸåç­‰ä½¿ç”¨å›½å†…çš„dnsè§£æ
    - https://1.12.12.12/dns-query
    - https://223.5.5.5/dns-query
    "geosite:gfw,geolocation-!cn": #éå›½å†…åŸŸåï¼Œè¢«æ±¡æŸ“åŸŸåï¼Œèµ°å¦ä¸€ä¸ªè§£æ
    - https://[2001:4860:4860::64]/dns-query
    - tls://1dot1dot1dot1.cloudflare-dns.com
    - tls://unfiltered.adguard-dns.com

  #nameserverå’Œfallbackæ˜¯å¹¶å‘,ä¼˜å…ˆä½¿ç”¨å“ªä¸ªçœ‹ä¸‹é¢çš„é…ç½®è§„åˆ™ï¼Œæ¯”å¦‚fallback-filter,ä¸Šé¢çš„è®¾ç½®ä¼˜å…ˆçº§é«˜ï¼ŒåŒ¹é…ä¸åˆ°äº†æ‰ä¼šèµ°åˆ°nameserver fallbackåˆ¤æ–­
  #è¿™é‡Œä¸ç”¨fallbackäº†ï¼Œä¸Šé¢çš„åˆ¤æ–­å·²ç»å¤Ÿå…¨äº†ï¼Œnameserverç”¨æ¥å…œåº•
  nameserver: #é»˜è®¤çš„åŸŸåè§£ææœåŠ¡å™¨
  - https://[2001:4860:4860::64]/dns-query
  - tls://1dot1dot1dot1.cloudflare-dns.com
  - tls://unfiltered.adguard-dns.com

#fake-ip æ¨¡å¼ä¸‹ï¼ŒClash ä¼šå°†åŸå§‹çš„åŸŸåï¼ˆhostnameï¼‰å‘é€åˆ°é¢„å…ˆé…ç½®çš„è¿œç«¯DNS æœåŠ¡å™¨è¿›è¡Œè§£æ
  enhanced-mode: fake-ip
  fake-ip-filter-mode: blacklist #blacklist æ¨¡å¼åªè¦æ²¡å‘½ä¸­fake-ip-filter,éƒ½ä¼šç»™fake ip
  fake-ip-filter: #fakeip è¿‡æ»¤ï¼Œä»¥ä¸‹åœ°å€ä¸ä¼šä¸‹å‘ fakeip æ˜ å°„ç”¨äºè¿æ¥
  - +.tvkuai.com
  - geosite:private
  - geosite:cn
  fake-ip-range: 198.18.0.1/16

# ä»£ç†ç»„é…ç½®
proxy-groups:
  - name: âœˆï¸ é€‰æ‹©ä»£ç†
    type: select
    proxies:
      - âš¡ï¸ è‡ªåŠ¨ä¼˜é€‰
      - âš–ï¸ è´Ÿè½½å‡è¡¡
      - ğŸ‘† æ‰‹åŠ¨é€‰æ‹©
      - DIRECT

  - name: âš¡ï¸ è‡ªåŠ¨ä¼˜é€‰
    type: url-test # é€šè¿‡ URL æµ‹è¯•é€‰æ‹©å»¶è¿Ÿæœ€ä½çš„èŠ‚ç‚¹
    tolerance: 10 # å»¶è¿Ÿå®¹å¿å€¼ï¼ˆmsï¼‰ï¼Œå½“æœ€ä¼˜èŠ‚ç‚¹å»¶è¿Ÿä¸æ–°èŠ‚ç‚¹å·®å¼‚å°äºæ­¤å€¼æ—¶ä¸åˆ‡æ¢
    include-all: true # Stash å…¼å®¹æ€§å†™æ³•
    url: "https://www.gstatic.com/generate_204" # ä½¿ç”¨ Google çš„ä¸“ç”¨ç½‘ç»œè¿é€šæ€§æµ‹è¯• URLï¼Œæ›´è½»é‡é«˜æ•ˆ
    expected-status: 204 # æœŸæœ›è·å¾— 204 çŠ¶æ€ç ï¼Œç¡®ä¿æµ‹è¯•çš„å‡†ç¡®æ€§ï¼Œé¿å…è¢«åŠ«æŒ
    interval: 60 # å¥åº·æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
    timeout: 3000 # å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    max-failed-times: 2 # æœ€å¤§å¤±è´¥æ¬¡æ•°
    lazy: true # æ‡’åŠ è½½ï¼Œå¯åŠ¨æ—¶ä¸è¿›è¡Œæµ‹è¯•

  - name: âš–ï¸ è´Ÿè½½å‡è¡¡
    type: load-balance # å®ç°æµé‡çš„è´Ÿè½½å‡è¡¡
    strategy: consistent-hashing # è½®è¯¢ç­–ç•¥ï¼Œç¡®ä¿åŒä¸€ç›®æ ‡åœ°å€ä½¿ç”¨åŒä¸€èŠ‚ç‚¹
    include-all: true # Stash å…¼å®¹æ€§å†™æ³•
    url: "https://www.gstatic.com/generate_204"
    expected-status: 204
    interval: 60
    timeout: 3000
    max-failed-times: 2
    lazy: true

  - name: ğŸ‘† æ‰‹åŠ¨é€‰æ‹©
    type: select # æ‰‹åŠ¨é€‰æ‹©èŠ‚ç‚¹
    include-all: true # Stash å…¼å®¹æ€§å†™æ³•
    url: "https://www.gstatic.com/generate_204"
    expected-status: 204
    interval: 60
    timeout: 3000
    max-failed-times: 2
    lazy: true

# è§„åˆ™é›†æä¾›è€…
rule-providers:
  applications:
    type: http
    # å¿…é¡»ä½¿ç”¨ classical æ¨¡å¼ï¼Œå› ä¸ºå…¶å†…å®¹æ˜¯ `PROCESS-NAME` è§„åˆ™ï¼Œè€Œéçº¯åŸŸååˆ—è¡¨
    behavior: classical
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt"
    path: ./ruleset/applications.yaml
    interval: 86400 # æ¯å¤©æ›´æ–°ä¸€æ¬¡

# è·¯ç”±è§„åˆ™
rules:
  # æ ¹æ® Stash å®˜æ–¹å»ºè®®ï¼Œç¦ç”¨ QUIC åè®®ä»¥æé«˜ä»£ç†è½¬å‘æ•ˆç‡
  - DOMAIN-KEYWORD,quic,REJECT
  # è‡ªå®šä¹‰ç›´è¿è§„åˆ™
  - DOMAIN,cdn.jsdelivr.net,DIRECT
  - DOMAIN,a.ppconverter.eu.org,DIRECT
  - DOMAIN,clash.razord.top,DIRECT
  - DOMAIN,yacd.haishan.me,DIRECT
  - 'DOMAIN-SUFFIX,ghproxy.com,DIRECT'
  - 'DOMAIN-SUFFIX,gofile.io,DIRECT'
  # ç›´è¿åº”ç”¨
  - RULE-SET,applications,DIRECT
  # å¹¿å‘Šæ‹¦æˆª
  - GEOSITE,category-ads-all,REJECT
  # å¸¸ç”¨æœåŠ¡
  - GEOSITE,bing,âœˆï¸ é€‰æ‹©ä»£ç†
  - GEOSITE,microsoft,âœˆï¸ é€‰æ‹©ä»£ç†
  # ç§æœ‰ç½‘ç»œ
  - GEOSITE,private,DIRECT
  # å›½å†…æµé‡ç›´è¿
  - GEOSITE,cn,DIRECT
  # å›½å¤–æµé‡èµ°ä»£ç†
  - GEOSITE,geolocation-!cn,âœˆï¸ é€‰æ‹©ä»£ç†
  # ç§æœ‰ç½‘ç»œ
  - GEOIP,private,DIRECT
  # å›½å†…æµé‡ç›´è¿
  - GEOIP,cn,DIRECT
  # å…œåº•è§„åˆ™
  - MATCH,âœˆï¸ é€‰æ‹©ä»£ç†
