# Stash ä¸“ç”¨é…ç½®æ¨¡æ¿
# æ ¹æ® Stash Wiki å®˜æ–¹æœ€ä½³å®è·µ (https://stash.wiki/faq/effective-stash) è¿›è¡Œäº†ä¼˜åŒ–ã€‚

mixed-port: 7890
ipv6: true
allow-lan: true
unified-delay: true
tcp-concurrent: true
external-controller: 127.0.0.1:9090
# external-ui: Stash æœ¬èº«å°±æ˜¯ UIï¼Œæ— éœ€æ­¤é¡¹

# GeoIP/GeoSite ç›¸å…³é…ç½®
geodata-mode: true
geo-auto-update: true
geo-update-interval: 24 # æ›´æ–°é—´éš”ï¼Œå•ä½ä¸ºå°æ—¶
geox-url:
  geoip: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/geoip.dat"
  mmdb: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-Country.mmdb"
  geosite: "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat"
  asn: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-ASN.mmdb"

# è¿›ç¨‹åŒ¹é…æ¨¡å¼ (ä»…é€‚ç”¨äº macOS/Linux)
find-process-mode: strict

# å…¨å±€ TLS æŒ‡çº¹ï¼Œç”¨äºæ¨¡ä»¿ç‰¹å®šå®¢æˆ·ç«¯çš„ TLS æ¡æ‰‹åŒ…
global-client-fingerprint: firefox

profile:
  store-selected: true # è®°å½•æ‰‹åŠ¨é€‰æ‹©çš„ä»£ç†
  store-fake-ip: true # è®°å½• fake-ip çš„æ˜ å°„å…³ç³»

sniffer:
  enable: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
  skip-domain:
    - "Mijia Cloud"
    - "+.push.apple.com"

tun:
  enable: false
  stack: gvisor
  dns-hijack:
    - "any:53"
    - "tcp://any:53"
  auto-route: true
  auto-redirect: true
  auto-detect-interface: true

# DNS é…ç½®
dns:
  enable: true
  ipv6: true
  use-system-hosts: false
  enhanced-mode: fake-ip # ä½¿ç”¨ fake-ip æ¨¡å¼ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½
  fake-ip-filter:
    - "+.tvkuai.com"
    - geosite:private
    - geosite:cn
  fake-ip-filter-mode: blacklist
  fake-ip-range: 198.18.0.1/16
  default-nameserver:
    - tls://[2001:4860:4860::8844]
    - tls://149.112.112.9
    - tls://94.140.14.141
    - https://[2a10:50c0::2:ff]
  nameserver:
    - tls://[2001:4860:4860::8844]
    - tls://149.112.112.9
    - tls://94.140.14.141
    - https://[2a10:50c0::2:ff]
  fallback:
    - tls://[2001:4860:4860::8844]
    - tls://149.112.112.9
    - tls://94.140.14.141
    - https://[2a10:50c0::2:ff]

# ä»£ç†ç»„é…ç½®
proxy-groups:
  - name: âœˆï¸ é€‰æ‹©ä»£ç†
    type: select
    proxies:
      - âš¡ï¸ è‡ªåŠ¨ä¼˜é€‰
      - âš–ï¸ è´Ÿè½½å‡è¡¡
      - ğŸ‘† æ‰‹åŠ¨é€‰æ‹©
      - DIRECT

  - name: âš¡ï¸ è‡ªåŠ¨ä¼˜é€‰
    type: url-test # é€šè¿‡ URL æµ‹è¯•é€‰æ‹©å»¶è¿Ÿæœ€ä½çš„èŠ‚ç‚¹
    tolerance: 10 # å»¶è¿Ÿå®¹å¿å€¼ï¼ˆmsï¼‰ï¼Œå½“æœ€ä¼˜èŠ‚ç‚¹å»¶è¿Ÿä¸æ–°èŠ‚ç‚¹å·®å¼‚å°äºæ­¤å€¼æ—¶ä¸åˆ‡æ¢
    include-all: true # Stash å…¼å®¹æ€§å†™æ³•
    url: "http://www.gstatic.com/generate_204" # ä½¿ç”¨ Google çš„ä¸“ç”¨ç½‘ç»œè¿é€šæ€§æµ‹è¯• URLï¼Œæ›´è½»é‡é«˜æ•ˆ
    expected-status: 204 # æœŸæœ›è·å¾— 204 çŠ¶æ€ç ï¼Œç¡®ä¿æµ‹è¯•çš„å‡†ç¡®æ€§ï¼Œé¿å…è¢«åŠ«æŒ
    interval: 60 # å¥åº·æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
    timeout: 3000 # å¥åº·æ£€æŸ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    max-failed-times: 2 # æœ€å¤§å¤±è´¥æ¬¡æ•°
    lazy: true # æ‡’åŠ è½½ï¼Œå¯åŠ¨æ—¶ä¸è¿›è¡Œæµ‹è¯•

  - name: âš–ï¸ è´Ÿè½½å‡è¡¡
    type: load-balance # å®ç°æµé‡çš„è´Ÿè½½å‡è¡¡
    strategy: consistent-hashing # è½®è¯¢ç­–ç•¥ï¼Œç¡®ä¿åŒä¸€ç›®æ ‡åœ°å€ä½¿ç”¨åŒä¸€èŠ‚ç‚¹
    include-all: true # Stash å…¼å®¹æ€§å†™æ³•
    url: "http://www.gstatic.com/generate_204"
    expected-status: 204
    interval: 60
    timeout: 3000
    max-failed-times: 2
    lazy: true

  - name: ğŸ‘† æ‰‹åŠ¨é€‰æ‹©
    type: select # æ‰‹åŠ¨é€‰æ‹©èŠ‚ç‚¹
    include-all: true # Stash å…¼å®¹æ€§å†™æ³•
    url: "http://www.gstatic.com/generate_204"
    expected-status: 204
    interval: 60
    timeout: 3000
    max-failed-times: 2
    lazy: true

# è§„åˆ™é›†æä¾›è€…
rule-providers:
  applications:
    type: http
    # å¿…é¡»ä½¿ç”¨ classical æ¨¡å¼ï¼Œå› ä¸ºå…¶å†…å®¹æ˜¯ `PROCESS-NAME` è§„åˆ™ï¼Œè€Œéçº¯åŸŸååˆ—è¡¨
    behavior: classical
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt"
    path: ./ruleset/applications.yaml
    interval: 86400 # æ¯å¤©æ›´æ–°ä¸€æ¬¡

# è·¯ç”±è§„åˆ™
rules:
  # æ ¹æ® Stash å®˜æ–¹å»ºè®®ï¼Œç¦ç”¨ QUIC åè®®ä»¥æé«˜ä»£ç†è½¬å‘æ•ˆç‡
  - DOMAIN-KEYWORD,quic,REJECT
  # è‡ªå®šä¹‰ç›´è¿è§„åˆ™
  - DOMAIN,cdn.jsdelivr.net,DIRECT
  - DOMAIN,a.ppconverter.eu.org,DIRECT
  - DOMAIN,clash.razord.top,DIRECT
  - DOMAIN,yacd.haishan.me,DIRECT
  - 'DOMAIN-SUFFIX,ghproxy.com,DIRECT'
  - 'DOMAIN-SUFFIX,gofile.io,DIRECT'
  # ç›´è¿åº”ç”¨
  - RULE-SET,applications,DIRECT
  # å¹¿å‘Šæ‹¦æˆª
  - GEOSITE,category-ads-all,REJECT
  # å¸¸ç”¨æœåŠ¡
  - GEOSITE,bing,é€‰æ‹©ä»£ç†
  - GEOSITE,microsoft,é€‰æ‹©ä»£ç†
  # ç§æœ‰ç½‘ç»œ
  - GEOSITE,private,DIRECT
  - GEOIP,private,DIRECT
  # å›½å†…æµé‡ç›´è¿
  - GEOSITE,geolocation-cn,DIRECT
  - GEOIP,cn,DIRECT
  # å›½å¤–æµé‡èµ°ä»£ç†
  - GEOSITE,geolocation-!cn,é€‰æ‹©ä»£ç†
  # å…œåº•è§„åˆ™
  - MATCH,é€‰æ‹©ä»£ç†
