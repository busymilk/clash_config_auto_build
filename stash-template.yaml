
# Stash 专用配置模板
# 根据 Stash Wiki 官方最佳实践 (https://stash.wiki/faq/effective-stash) 进行了深度优化。

mixed-port: 7890
ipv6: true
allow-lan: true
unified-delay: true
tcp-concurrent: true
external-controller: 127.0.0.1:9090

# GeoIP/GeoSite 相关配置
geodata-mode: true
geo-auto-update: true
geo-update-interval: 24
geox-url:
  geoip: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/geoip.dat"
  mmdb: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-Country.mmdb"
  geosite: "https://cdn.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat"
  asn: "https://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/GeoLite2-ASN.mmdb"

find-process-mode: strict
global-client-fingerprint: firefox

profile:
  store-selected: true
  store-fake-ip: true

sniffer:
  enable: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
  skip-domain:
    - "Mijia Cloud"
    - "+.push.apple.com"

tun:
  enable: false
  stack: gvisor
  dns-hijack:
    - "any:53"
    - "tcp://any:53"
  auto-route: true
  auto-redirect: true
  auto-detect-interface: true

# DNS 配置根据 Stash 官方建议进行精简，以降低移动端资源消耗
dns:
  enable: true
  ipv6: true
  use-system-hosts: false
  enhanced-mode: fake-ip
  fake-ip-filter:
    - "+.tvkuai.com"
    - geosite:private
    - geosite:cn
  fake-ip-filter-mode: blacklist
  fake-ip-range: 198.18.0.1/16
  # 优先使用稳定、高效的公共 DNS
  default-nameserver:
    - 223.5.5.5
    - 119.29.29.29
  nameserver:
    - 223.5.5.5
    - 119.29.29.29
  fallback:
    - 1.0.0.1
    - 8.8.4.4

# 代理组配置
proxy-groups:
  - name: 选择代理
    type: select
    proxies:
      - 自动优选
      - 负载均衡
      - 手动选择
      - DIRECT

  - name: 自动优选
    type: url-test
    tolerance: 10
    include-all-proxies: true
    url: "https://www.apple.com/library/test/success.html"
    interval: 60
    timeout: 3000
    max-failed-times: 2
    lazy: true

  - name: 负载均衡
    type: load-balance
    strategy: consistent-hashing
    include-all-proxies: true
    url: "https://www.apple.com/library/test/success.html"
    interval: 60
    timeout: 3000
    max-failed-times: 2
    lazy: true

  - name: 手动选择
    type: select
    include-all-proxies: true
    url: "https://www.apple.com/library/test/success.html"
    interval: 60
    timeout: 3000
    max-failed-times: 2
    lazy: true

# 规则集提供者
rule-providers:
  applications:
    type: http
    # 根据 Stash 官方建议，使用 domain 模式以提升性能和降低内存占用
    behavior: domain
    url: "https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release/applications.txt"
    path: ./ruleset/applications.yaml
    interval: 86400

# 路由规则
rules:
  # 根据 Stash 官方建议，禁用 QUIC 协议以提高代理转发效率
  - DOMAIN-KEYWORD,quic,REJECT
  # 自定义直连规则
  - DOMAIN,cdn.jsdelivr.net,DIRECT
  - DOMAIN,a.ppconverter.eu.org,DIRECT
  - DOMAIN,clash.razord.top,DIRECT
  - DOMAIN,yacd.haishan.me,DIRECT
  - 'DOMAIN-SUFFIX,ghproxy.com,DIRECT'
  - 'DOMAIN-SUFFIX,gofile.io,DIRECT'
  # 直连应用
  - RULE-SET,applications,DIRECT
  # 广告拦截
  - GEOSITE,category-ads-all,REJECT
  # 常用服务
  - GEOSITE,bing,选择代理
  - GEOSITE,microsoft,选择代理
  # 私有网络
  - GEOSITE,private,DIRECT
  - GEOIP,private,DIRECT
  # 国内流量直连
  - GEOSITE,geolocation-cn,DIRECT
  - GEOIP,cn,DIRECT
  # 国外流量走代理
  - GEOSITE,geolocation-!cn,选择代理
  # 兜底规则
  - MATCH,选择代理
