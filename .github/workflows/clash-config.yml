name: Generate Clash Config

on:
  schedule:
    # æ¯2å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 */2 * * *'
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘
  
  #push:
  #  branches: [ "main" ]   #æœ‰æ”¹åŠ¨æ—¶è¿›è¡Œè§¦å‘

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
     # å…³é”®ä¿®æ”¹ 1/2ï¼šé…ç½®å¸¦æƒé™çš„ checkout
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}  # æ˜¾å¼ä¼ é€’ä»¤ç‰Œ
        fetch-depth: 0  # è·å–å®Œæ•´æäº¤å†å²

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install pyyaml

    - name: Create directories
      run: mkdir -p external_proxies config

    - name: Download external proxies
      env:
        LANG: en_US.UTF-8
        LC_ALL: en_US.UTF-8
        # ä»ä»“åº“å˜é‡è¯»å–URLåˆ—è¡¨
        URL_LIST: ${{ vars.URL_LIST }}
      run: |
        mkdir -p external_proxies
        IFS=' ' read -ra URLS <<< "$URL_LIST"
        for url in "${URLS[@]}"; do
          # ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼šç§»é™¤åè®®å’ŒåŸŸåï¼Œæ›¿æ¢è·¯å¾„ä¸­çš„ç‰¹æ®Šå­—ç¬¦
          filename=$(echo "$url" | sed -E 's#^https?://[^/]+/##; s/[?#].*$//; s#/#_#g')
          output="external_proxies/${filename}"
          echo "Downloading $url"
          curl -sSL "$url" -o "$output" || echo "Failed: $url"
          echo "Download finished: $output"
        done
    

    - name: Merge proxies
      env:
        LANG: en_US.UTF-8
        LC_ALL: en_US.UTF-8
      run: python -u scripts/merge_proxies.py

    - name: Generate config
      env:
        LANG: en_US.UTF-8
        LC_ALL: en_US.UTF-8
      run: python scripts/generate_config.py
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: clash-config
        path: config/config.yaml

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        files: config/config.yaml
        tag_name: clash-config
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.TOKEN }}

#æäº¤æ›´æ”¹
    # - name: GitCommit
    #   run: |
    #     git config --local user.email "actions@github.com"
    #     git config --local user.name "GitHub Actions"
    #     git add ./config/config.yaml
    #     git commit -m "merge: $(date '+%Y-%m-%d %H:%M:%S') åˆå¹¶èŠ‚ç‚¹"
    #     git push
# å…³é”®ä¿®æ”¹ 2/2ï¼šä¿®å¤æ¨é€æƒé™
    - name: Commit and push config changes
      env:
        # ä½¿ç”¨ GitHub Token ä½œä¸ºè®¤è¯å‡­æ®
        REPO_URL: https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
      run: |
        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # æ‹‰å–æœ€æ–°ä»£ç é˜²æ­¢å†²çª
        git pull origin main
        
        # æ£€æµ‹æ–‡ä»¶æ˜¯å¦æœ‰å®é™…å˜æ›´
        if git diff --quiet --exit-code -- config/config.yaml; then
          echo "No changes to commit"
          exit 0
        fi

        # æäº¤å¹¶æ¨é€å˜æ›´
        git add config/config.yaml
        git commit -m "chore: Auto-update config file ($(date +'%Y-%m-%d %H:%M'))"
        
        # æ˜¾å¼ä½¿ç”¨è®¤è¯åçš„ä»“åº“URL
        git remote set-url origin $REPO_URL
        git push origin HEAD:main

#é€šçŸ¥cdnæ›´ç¼“å­˜
    - name: Purge jsDelivr Cache with Retry
      if: success()
      env:
        MAX_RETRIES: 3
        RETRY_DELAY: 10
      run: |
        purge_url="https://purge.jsdelivr.net/gh/${{ github.repository }}@main/config/config.yaml"
        echo "ğŸ”„ Purging: ${purge_url/https:\/\//}"
    
        for i in $(seq 1 $MAX_RETRIES); do
          echo "Attempt $i/$MAX_RETRIES"
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "$purge_url")
          
          case $http_code in
            200)
              echo "âœ… Purge successful"
              exit 0
              ;;
            429)
              echo "âš ï¸  Rate limited, retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
              ;;
            *)
              echo "âŒ Unexpected code: $http_code"
              if [ $i -eq $MAX_RETRIES ]; then
                exit 1
              fi
              ;;
          esac
        done
