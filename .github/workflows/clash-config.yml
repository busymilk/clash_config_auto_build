name: Generate Clash Config

on:
  schedule:
    # æ¯4å°æ—¶è¿è¡Œä¸€æ¬¡ï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 */4 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  generate:
    runs-on: ubuntu-latest
    # å°†ç¯å¢ƒå˜é‡æå‡åˆ° job çº§åˆ«ï¼Œé¿å…åœ¨æ¯ä¸ª step ä¸­é‡å¤å®šä¹‰
    env:
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
      GITHUB_TOKEN: ${{ secrets.TOKEN }}

    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç ä»“åº“
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨ GITHUB_TOKEN ä»¥è·å–æ¨é€æƒé™
        fetch-depth: 0 # è·å–å®Œæ•´çš„ git å†å²ï¼Œä»¥ä¾¿è¿›è¡Œ diff å’Œ commit

    # æ­¥éª¤2: è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    # æ­¥éª¤3: å®‰è£… Python ä¾èµ–
    - name: Install dependencies
      run: pip install pyyaml

    # æ­¥éª¤4: åˆ›å»ºæ‰€éœ€ç›®å½•
    - name: Create directories
      run: mkdir -p external_proxies config

    # æ­¥éª¤5: ä¸‹è½½å¤–éƒ¨ä»£ç†è®¢é˜…æ–‡ä»¶
    - name: Download external proxies
      env:
        URL_LIST: ${{ vars.URL_LIST }} # ä»ä»“åº“çš„ Variables ä¸­è¯»å–è®¢é˜…URLåˆ—è¡¨
      run: |
        # ä½¿ç”¨ IFSï¼ˆå†…éƒ¨å­—æ®µåˆ†éš”ç¬¦ï¼‰æ¥å®‰å…¨åœ°å¤„ç†å¸¦ç©ºæ ¼çš„URL
        IFS=' ' read -ra URLS <<< "$URL_LIST"
        for url in "${URLS[@]}"; do
          # æ ¹æ® URL ç”Ÿæˆä¸€ä¸ªç›¸å¯¹å”¯ä¸€ä¸”åˆæ³•çš„æ–‡ä»¶å
          basename=$(echo "$url" | sed -E 's#^https?://[^/]+/##; s/[?#].*$//; s#/#_#g')
          timestamp=$(date +%s%N)
          filename="${basename}_${timestamp}"
          # ç¡®ä¿æ–‡ä»¶åæœ‰åç¼€ï¼Œä»¥å…¼å®¹æŸäº›ç³»ç»Ÿ
          if [[ "$filename" != *.* ]]; then
            filename="${filename}.txt"
          fi
          
          output="external_proxies/${filename}"
          echo "Downloading $url to $output"
          # ä½¿ç”¨ curl ä¸‹è½½ï¼Œ-sSL è¡¨ç¤ºé™é»˜ã€è·Ÿéšé‡å®šå‘ã€æ˜¾ç¤ºé”™è¯¯
          curl -sSL "$url" -o "$output" || echo "Failed to download: $url"
        done

    # æ­¥éª¤6: åˆå¹¶æ‰€æœ‰ä»£ç† (åŒ…æ‹¬æ‰€æœ‰åœ°åŒºã€é¦™æ¸¯ã€ç¾å›½)
    - name: Merge all proxies
      run: |
        # -- åˆå¹¶æ‰€æœ‰ä»£ç† --
        python -u scripts/merge_proxies.py --output merged-proxies.yaml
        # -- ä»…åˆå¹¶é¦™æ¸¯ä»£ç† --
        python -u scripts/merge_proxies.py --filter hk --output merged-proxies_hk.yaml
        # -- ä»…åˆå¹¶ç¾å›½ä»£ç† --
        python -u scripts/merge_proxies.py --filter us --output merged-proxies_us.yaml

    # æ­¥éª¤7: ç”Ÿæˆæ‰€æœ‰æœ€ç»ˆçš„é…ç½®æ–‡ä»¶
    - name: Generate all configs
      run: python scripts/generate_config.py

    # æ­¥éª¤8: å°†ç”Ÿæˆçš„é…ç½®æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©ä¸Šä¼ 
    # è¿™å…è®¸ç”¨æˆ·åœ¨ Actions é¡µé¢ç›´æ¥ä¸‹è½½ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œä½¿ç”¨
    - name: Upload All Config Artifact
      uses: actions/upload-artifact@v4
      with:
        name: clash-config-all
        path: config/config.yaml

    - name: Upload US Config Artifact
      uses: actions/upload-artifact@v4
      with:
        name: clash-config-us
        path: config/config_us.yaml

    - name: Upload HK Config Artifact
      uses: actions/upload-artifact@v4
      with:
        name: clash-config-hk
        path: config/config_hk.yaml

    # æ­¥éª¤9: åˆ›å»ºæˆ–æ›´æ–° GitHub Release
    # ä½¿ç”¨ softprops/action-gh-release æ’ä»¶æ¥è‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹
    - name: Create or Update Release
      uses: softprops/action-gh-release@v1
      with:
        # å°†æ‰€æœ‰é…ç½®æ–‡ä»¶æ‰“åŒ…åˆ°ä¸€ä¸ª release ä¸­
        files: |
          config/config.yaml
          config/config_hk.yaml
          config/config_us.yaml
        # ä½¿ç”¨å›ºå®šçš„ tag_nameï¼Œè¿™æ ·æ¯æ¬¡è¿è¡Œéƒ½ä¼šæ›´æ–°åŒä¸€ä¸ª Release
        tag_name: latest-config
        name: "ğŸš€ Latest Clash Configurations"
        body: "Automated update of Clash configuration files."
        generate_release_notes: true # è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬è¯´æ˜

    # æ­¥éª¤10: æäº¤å¹¶æ¨é€é…ç½®æ–‡ä»¶çš„å˜æ›´åˆ°ä»“åº“
    - name: Commit and push config changes
      run: |
        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # å®šä¹‰éœ€è¦è·Ÿè¸ªå˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
        FILES_TO_CHECK=("config/config.yaml" "config/config_hk.yaml" "config/config_us.yaml")
        
        # ä½¿ç”¨ git diff --quiet æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å‘ç”Ÿå˜æ›´
        if git diff --quiet --exit-code -- "${FILES_TO_CHECK[@]}"; then
          echo "No changes to commit, skipping push."
          exit 0
        fi
        
        # å¦‚æœæœ‰å˜æ›´ï¼Œåˆ™æ·»åŠ åˆ°æš‚å­˜åŒºå¹¶æäº¤
        git add "${FILES_TO_CHECK[@]}"
        COMMIT_MSG="chore(auto-update): Update config files at $(date +'%Y-%m-%d %H:%M')"
        git commit -m "$COMMIT_MSG"
        
        # æ¨é€åˆ° main åˆ†æ”¯
        git push origin HEAD:main

    # æ­¥éª¤11: åˆ·æ–° jsDelivr çš„ CDN ç¼“å­˜
    # ç¡®ä¿ç”¨æˆ·èƒ½é€šè¿‡ jsDelivr é“¾æ¥è®¿é—®åˆ°æœ€æ–°çš„é…ç½®æ–‡ä»¶
    - name: Purge jsDelivr Cache
      if: success() # ä»…åœ¨å‰é¢æ­¥éª¤éƒ½æˆåŠŸæ—¶æ‰§è¡Œ
      env:
        MAX_RETRIES: 3
        RETRY_DELAY: 20
      run: |
        FILES_TO_PURGE=("config/config.yaml" "config/config_us.yaml" "config/config_hk.yaml")
        GLOBAL_ERROR=0

        for file in "${FILES_TO_PURGE[@]}"; do
          purge_url="https://purge.jsdelivr.net/gh/${{ github.repository }}@main/$file"
          echo "Purging CDN cache for: $file"
          
          # å¢åŠ é‡è¯•é€»è¾‘ä»¥åº”å¯¹ä¸´æ—¶çš„ç½‘ç»œé—®é¢˜æˆ–APIé€Ÿç‡é™åˆ¶
          for ((i=1; i<=$MAX_RETRIES; i++)); do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" "$purge_url")
            if [ $http_code -eq 200 ]; then
              echo "  âœ… Success (Attempt $i)"
              break
            elif [ $i -eq $MAX_RETRIES ]; then
              echo "  âŒ Failed after $MAX_RETRIES attempts (HTTP code: $http_code)"
              GLOBAL_ERROR=1
            else
              echo "  âš ï¸ Failed with code $http_code, retrying in $RETRY_DELAY seconds..."
              sleep $RETRY_DELAY
            fi
          done
        done

        if [ $GLOBAL_ERROR -ne 0 ]; then
          echo "â›” One or more files failed to purge from jsDelivr cache."
          exit 1
        else
          echo "ğŸ‰ All files purged successfully."
        fi